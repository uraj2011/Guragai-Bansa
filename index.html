<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Family Tree</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAmSZ4WkTKFWu5sa5fUsGeJhulqlePadoQ",
    authDomain: "guragai-family-tree.firebaseapp.com",
    projectId: "guragai-family-tree",
    storageBucket: "guragai-family-tree.firebasestorage.app",
    messagingSenderId: "212982176325",
    appId: "1:212982176325:web:dfb3aba19d167470b3212c",
    measurementId: "G-W6VRQB1LYP"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* This CSS creates the connecting lines for the tree structure */
        .children-container {
            position: relative;
        }
        .children-container::before {
            content: '';
            position: absolute;
            top: -12px; /* Position the line above the children, connecting to the parent */
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 12px;
            background-color: #9ca3af; /* Line color */
        }
        .tree-node-wrapper {
            position: relative;
            transition: all 0.3s ease-in-out;
        }
        /* Horizontal line above each child */
        .tree-node-wrapper::before {
            content: '';
            position: absolute;
            top: -14px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: #9ca3af; /* Line color */
            transform: translateX(-50%);
        }
        /* Vertical line connecting the horizontal line to the child card */
        .tree-node-wrapper::after {
            content: '';
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 14px;
            background-color: #9ca3af; /* Line color */
        }

        /* Adjustments for the first and last child to create the 'T' shape */
        .children-container > .tree-node-wrapper:first-child:not(:only-child)::before {
            left: 75%;
            width: 50%;
        }
        .children-container > .tree-node-wrapper:last-child:not(:only-child)::before {
            left: 25%;
            width: 50%;
        }
        .children-container > .tree-node-wrapper:only-child::before {
            display: none; /* No horizontal line if there's only one child */
        }

        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: #fff;
            }
            .p-2.rounded-xl.mb-4 {
                 page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- SVG Icon Components ---
        const Plus = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="M12 5v14" /></svg> );
        const Minus = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /></svg> );
        const ChevronRight = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg> );
        const ChevronLeft = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg> );
        const X = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"></path></svg> );
        const Heart = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> );
        const Male = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="18" r="3"></circle><path d="M12 15v-6M18 9h-3M9 9h-3"></path></svg> );
        const Female = ({ size }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="6" r="3"></circle><path d="M12 9v9M15 15h-6"></path></svg> );
        const EditIcon = ({ size, hasContent, color }) => ( <svg className={`cursor-pointer text-${color}-500`} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={hasContent ? `currentColor` : `none`} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg> );
        const SpouseEditIcon = ({ size, hasContent, color }) => ( <svg className={`cursor-pointer text-${color}-500`} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={hasContent ? `currentColor` : `none`} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 15h-3a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5h3"></path><path d="M13 9h3a5 5 0 0 1 5 5v3a5 5 0 0 1-5 5h-3"></path><line x1="8" y1="2" x2="8" y2="7"></line><line x1="16" y1="17" x2="16" y2="22"></line><line x1="16" y1="2" x2="16" y2="7"></line></svg> );
        const TombstoneIcon = ({ size, hasContent, color }) => ( <svg className={`cursor-pointer text-${color}-500`} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={hasContent ? `currentColor` : `none`} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-2v2h2v-2z"></path><path d="M14 10h-2v2h2v-2z"></path><path d="M10 10h-2v2h2v-2z"></path><path d="M12 2a4 4 0 0 0-4 4v7h8v-7a4 4 0 0 0-4-4z"></path><path d="M4 17h16"></path><path d="M12 17a4 4 0 0 0-4 4"></path><path d="M12 17a4 4 0 0 1 4 4"></path><path d="M12 21v-4"></path></svg> );

        const getGenerationColor = (generation) => {
            const colors = ['4f46e5', 'db2777', '22c55e', 'f97316', '8b5cf6', '14b8a6'];
            return colors[((generation || 1) - 1) % colors.length];
        };

        // --- Default Data & Modals ---
        const defaultFamilyData = [
             { id: 1, name: "Grandpa Robert", lastName: "Smith", reportsTo: null, isExpanded: true, isCarouselMode: false, activeIndex: 0, spouseName: "Grandma Jane", spouseLastName: "Jones", isMarried: true, gender: 'male', story: "A proud veteran and loving grandfather.", dob: "1945-03-21", placeOfBirth: "New York, USA", isAlive: false, dateOfDeath: "2015-01-10", placeOfCremation: "Arlington National Cemetery, VA", spouseStory: "A loving partner who enjoyed gardening.", spouseDob: "1947-07-04", spousePlaceOfBirth: "Chicago, USA", spouseIsAlive: true, spouseDateOfDeath: "", spousePlaceOfCremation: "", generation: 1 },
             { id: 2, name: "Son Michael", lastName: "Smith", reportsTo: 1, isExpanded: true, isCarouselMode: false, activeIndex: 0, spouseName: "Wife Jessica", spouseLastName: "Davis", isMarried: true, gender: 'male', story: "", dob: "", placeOfBirth: "", isAlive: true, coupleStory: "", spouseStory: "", spouseDob: "", spousePlaceOfBirth: "", spouseIsAlive: true, spouseDateOfDeath: "", spousePlaceOfCremation: "", generation: 2 },
             { id: 4, name: "Daughter Emily", lastName: "Smith", reportsTo: 1, isExpanded: true, isCarouselMode: false, activeIndex: 0, spouseName: "Husband David", spouseLastName: "Wilson", isMarried: true, gender: 'female', story: "Traveled the world for a year after college.", dob: "1975-08-15", placeOfBirth: "London, UK", isAlive: true, coupleStory: "", spouseStory: "", spouseDob: "", spousePlaceOfBirth: "", spouseIsAlive: true, spouseDateOfDeath: "", spousePlaceOfCremation: "", generation: 2 },
             { id: 5, name: "Grandchild Ethan", lastName: "Smith", reportsTo: 2, isExpanded: true, isCarouselMode: false, activeIndex: 0, spouseName: "", spouseLastName: "", isMarried: false, gender: 'male', story: "", dob: "", placeOfBirth: "", isAlive: true, coupleStory: "", spouseStory: "", spouseDob: "", spousePlaceOfBirth: "", spouseIsAlive: true, spouseDateOfDeath: "", spousePlaceOfCremation: "", generation: 3 },
             { id: 6, name: "Grandchild Olivia", lastName: "Smith", reportsTo: 2, isExpanded: true, isCarouselMode: false, activeIndex: 0, spouseName: "", spouseLastName: "", isMarried: false, gender: 'female', story: "", dob: "", placeOfBirth: "", isAlive: true, coupleStory: "", spouseStory: "", spouseDob: "", spousePlaceOfBirth: "", spouseIsAlive: true, spouseDateOfDeath: "", spousePlaceOfCremation: "", generation: 3 },
             { id: 7, name: "Grandchild Liam", lastName: "Wilson", reportsTo: 4, isExpanded: true, isCarouselMode: false, activeIndex: 0, spouseName: "", spouseLastName: "", isMarried: false, gender: 'male', story: "", dob: "", placeOfBirth: "", isAlive: true, coupleStory: "", spouseStory: "", spouseDob: "", spousePlaceOfBirth: "", spouseIsAlive: true, spouseDateOfDeath: "", spousePlaceOfCremation: "", generation: 3 },
        ];
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div className="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onConfirm, onCancel, message }) => (
            <Modal isOpen={isOpen} onClose={onCancel} title="Confirm Deletion">
                <p className="text-sm text-gray-700 mb-4">{message}</p>
                <div className="flex justify-end space-x-2">
                    <button onClick={onCancel} className="px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors text-sm">Cancel</button>
                    <button onClick={onConfirm} className="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors text-sm">Confirm</button>
                </div>
            </Modal>
        );

        const StoryModal = ({ isOpen, onClose, onSave, member, isSpouse }) => {
            const [story, setStory] = useState("");
            const [dob, setDob] = useState("");
            const [placeOfBirth, setPlaceOfBirth] = useState("");
            const [isAlive, setIsAlive] = useState(true);
            const [dateOfDeath, setDateOfDeath] = useState("");
            const [placeOfCremation, setPlaceOfCremation] = useState("");

            useEffect(() => {
                if (member) {
                    setStory(isSpouse ? member.spouseStory || "" : member.story || "");
                    setDob(isSpouse ? member.spouseDob || "" : member.dob || "");
                    setPlaceOfBirth(isSpouse ? member.spousePlaceOfBirth || "" : member.placeOfBirth || "");
                    setIsAlive(isSpouse ? member.spouseIsAlive ?? true : member.isAlive ?? true);
                    setDateOfDeath(isSpouse ? member.spouseDateOfDeath || "" : member.dateOfDeath || "");
                    setPlaceOfCremation(isSpouse ? member.spousePlaceOfCremation || "" : member.placeOfCremation || "");
                }
            }, [member, isSpouse, isOpen]);

            const handleSave = () => {
                onSave(member.id, { story, dob, placeOfBirth, isAlive, dateOfDeath, placeOfCremation }, isSpouse);
            };

            const personName = isSpouse ? member?.spouseName : member?.name;
            if (!member) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Edit Details for ${personName}`}>
                    <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <div className="flex items-center space-x-2">
                             <input type="checkbox" id="isAlive" checked={isAlive} onChange={(e) => setIsAlive(e.target.checked)} className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
                             <label htmlFor="isAlive" className="text-sm font-medium text-gray-700">Is Alive?</label>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Date of Birth</label>
                            <input type="date" value={dob} onChange={(e) => setDob(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Place of Birth</label>
                            <input type="text" value={placeOfBirth} onChange={(e) => setPlaceOfBirth(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm" placeholder="e.g., City, Country"/>
                        </div>
                        {!isAlive && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Date of Death</label>
                                    <input type="date" value={dateOfDeath} onChange={(e) => setDateOfDeath(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Place of Cremation/Burial</label>
                                    <input type="text" value={placeOfCremation} onChange={(e) => setPlaceOfCremation(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm" placeholder="e.g., Green Lawn Cemetery" />
                                </div>
                            </>
                        )}
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Story</label>
                            <textarea value={story} onChange={(e) => setStory(e.target.value)} rows="4" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm" placeholder="Add a personal story or a memorable fact..."></textarea>
                        </div>
                    </div>
                    <div className="mt-4 flex justify-end space-x-2">
                        <button onClick={onClose} className="px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors text-sm">Cancel</button>
                        <button onClick={handleSave} className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm">Save</button>
                    </div>
                </Modal>
            );
        };
        
        // --- TreeNode Component ---
        function TreeNode({ member, onAdd, onRemove, onNameChange, onLastNameChange, onSpouseNameChange, onSpouseLastNameChange, onOpenStoryModal, onToggleExpand, onToggleCarousel, onSetActiveIndex, onSetMarried, searchTerm, nodeRefs }) {
            const [isNameEditing, setIsNameEditing] = useState(false);
            const [isLastNameEditing, setIsLastNameEditing] = useState(false);
            const [isSpouseNameEditing, setIsSpouseNameEditing] = useState(false);
            const [isSpouseLastNameEditing, setIsSpouseLastNameEditing] = useState(false);
            
            const [editedName, setEditedName] = useState(member.name);
            const [editedLastName, setEditedLastName] = useState(member.lastName);
            const [editedSpouseName, setEditedSpouseName] = useState(member.spouseName);
            const [editedSpouseLastName, setEditedSpouseLastName] = useState(member.spouseLastName);
            
            const nameInputRef = useRef(null);
            const lastNameInputRef = useRef(null);
            const spouseNameInputRef = useRef(null);
            const spouseLastNameInputRef = useRef(null);

            useEffect(() => { setEditedName(member.name); }, [member.name]);
            useEffect(() => { setEditedLastName(member.lastName); }, [member.lastName]);
            useEffect(() => { setEditedSpouseName(member.spouseName); }, [member.spouseName]);
            useEffect(() => { setEditedSpouseLastName(member.spouseLastName); }, [member.spouseLastName]);
            
            useEffect(() => { if (isNameEditing) nameInputRef.current?.focus(); }, [isNameEditing]);
            useEffect(() => { if (isLastNameEditing) lastNameInputRef.current?.focus(); }, [isLastNameEditing]);
            useEffect(() => { if (isSpouseNameEditing) spouseNameInputRef.current?.focus(); }, [isSpouseNameEditing]);
            useEffect(() => { if (isSpouseLastNameEditing) spouseLastNameInputRef.current?.focus(); }, [isSpouseLastNameEditing]);

            const color = getGenerationColor(member.generation);
            const getGenderBoxColor = (gender) => gender === 'male' ? 'bg-sky-100 text-sky-800' : 'bg-pink-100 text-pink-800';
            const getSpouseBoxColor = (gender) => gender === 'male' ? 'bg-pink-100 text-pink-800' : 'bg-sky-100 text-sky-800';
            const getSpouseIconColor = (gender) => gender === 'male' ? 'pink' : 'sky';

            const handleBlur = (setter, id, value) => { setter(id, value); };
            const handleKeyDown = (e, blurFunc) => { if (e.key === 'Enter') blurFunc(); };

            const hasSpouse = !!member.isMarried;
            const hasChildren = member.children && member.children.length > 0;
            const children = member.children || [];
            const isCarouselMode = member.isCarouselMode;
            const activeIndex = member.activeIndex || 0;
            const showPrevButton = activeIndex > 0;
            const showNextButton = activeIndex < children.length - 1;

            const isHighlighted = searchTerm && (
                member.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                member.lastName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                member.spouseName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                member.spouseLastName?.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            return (
                <div className="relative flex flex-col items-center p-2 mb-4">
                    <div className={`p-1 rounded-xl shadow-md border-2 bg-white transition-all duration-300 hover:shadow-xl w-36 sm:w-40 mx-auto flex flex-col ${isHighlighted ? 'ring-4 ring-offset-2 ring-yellow-400' : ''}`} style={{borderColor: `#${color}`}}>
                        <div className={`p-0.5 w-full rounded-t-lg text-white font-bold text-[9px] flex items-center justify-center`} style={{ backgroundColor: `#${color}` }}>
                            G{member.generation}
                        </div>
                        <div className="flex justify-start items-start h-full flex-col p-1">
                            {/* Main Member Card */}
                            <div className={`relative rounded-lg shadow-sm border w-full mb-1 text-center ${getGenderBoxColor(member.gender)}`} ref={el => nodeRefs.current[member.id] = el} data-id={member.id} style={{borderColor: `#${color}`}}>
                                <div className="relative flex items-center w-full">
                                    {isNameEditing ? (
                                        <input type="text" ref={nameInputRef} className="flex-grow text-xs font-semibold p-0.5 text-center bg-transparent focus:outline-none focus:bg-white/50 rounded" value={editedName} onChange={(e) => setEditedName(e.target.value)} onBlur={() => {setIsNameEditing(false); onNameChange(member.id, editedName);}} onKeyDown={(e) => handleKeyDown(e, () => nameInputRef.current.blur())} />
                                    ) : (
                                        <span onClick={() => setIsNameEditing(true)} className="flex-grow text-xs font-semibold p-0.5 text-center cursor-pointer">{member.name || "Click to add"}</span>
                                    )}
                                </div>
                                <div className="relative flex items-center w-full">
                                    {isLastNameEditing ? (
                                        <input type="text" ref={lastNameInputRef} className="flex-grow text-[10px] p-0.5 text-center bg-transparent focus:outline-none focus:bg-white/50 rounded" value={editedLastName} onChange={(e) => setEditedLastName(e.target.value)} onBlur={() => {setIsLastNameEditing(false); onLastNameChange(member.id, editedLastName);}} onKeyDown={(e) => handleKeyDown(e, () => lastNameInputRef.current.blur())} />
                                    ) : (
                                        <span onClick={() => setIsLastNameEditing(true)} className="flex-grow text-[10px] p-0.5 text-center cursor-pointer">{member.lastName || "Click to add"}</span>
                                    )}
                                    <button onClick={() => onOpenStoryModal(member, false)} className="absolute -top-1 -right-1 p-0.5 bg-white/80 rounded-full hover:bg-gray-200 transition-colors" aria-label="Edit details">
                                        {member.isAlive ? <EditIcon size={12} hasContent={!!member.story || !!member.dob || !member.isAlive} color="blue" /> : <TombstoneIcon size={12} hasContent={!!member.dateOfDeath} color="gray" />}
                                    </button>
                                </div>
                                {hasSpouse && (
                                    <>
                                        <div className="border-b-2 border-gray-300 mx-1 my-0.5"></div>
                                        <div className={`relative flex items-center w-full ${getSpouseBoxColor(member.gender)} rounded-b-md -m-px p-px`}>
                                            <div className="flex-grow">
                                                {isSpouseNameEditing ? (
                                                    <input type="text" ref={spouseNameInputRef} className="w-full text-xs font-semibold p-0.5 text-center bg-transparent focus:outline-none focus:bg-white/50 rounded" value={editedSpouseName} onChange={(e) => setEditedSpouseName(e.target.value)} onBlur={() => {setIsSpouseNameEditing(false); onSpouseNameChange(member.id, editedSpouseName);}} onKeyDown={(e) => handleKeyDown(e, () => spouseNameInputRef.current.blur())} />
                                                ) : (
                                                    <span onClick={() => setIsSpouseNameEditing(true)} className="w-full block text-xs font-semibold p-0.5 text-center cursor-pointer">{member.spouseName || "Spouse Name"}</span>
                                                )}
                                                {isSpouseLastNameEditing ? (
                                                    <input type="text" ref={spouseLastNameInputRef} className="w-full text-[10px] p-0.5 text-center bg-transparent focus:outline-none focus:bg-white/50 rounded" value={editedSpouseLastName} onChange={(e) => setEditedSpouseLastName(e.target.value)} onBlur={() => {setIsSpouseLastNameEditing(false); onSpouseLastNameChange(member.id, editedSpouseLastName);}} onKeyDown={(e) => handleKeyDown(e, () => spouseLastNameInputRef.current.blur())} />
                                                ) : (
                                                    <span onClick={() => setIsSpouseLastNameEditing(true)} className="w-full block text-[10px] p-0.5 text-center cursor-pointer">{member.spouseLastName || "Spouse Last Name"}</span>
                                                )}
                                            </div>
                                            <button onClick={() => onSetMarried(member.id, false)} className="absolute top-1 right-1 p-0.5 text-red-500 rounded-full hover:bg-red-100 transition-colors" aria-label="Remove spouse"> <X size={10} /> </button>
                                            <button onClick={() => onOpenStoryModal(member, true)} className="absolute -top-1 -left-1 p-0.5 bg-white/80 rounded-full hover:bg-gray-200 transition-colors" aria-label="Edit spouse details">
                                                {member.spouseIsAlive ? <SpouseEditIcon size={12} hasContent={!!member.spouseStory || !!member.spouseDob || !member.spouseIsAlive} color={getSpouseIconColor(member.gender)} /> : <TombstoneIcon size={12} hasContent={!!member.spouseDateOfDeath} color="gray" />}
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                            
                            {!hasSpouse && (
                                <button onClick={() => onSetMarried(member.id, true)} className="no-print w-full p-1 my-0.5 text-pink-500 rounded-lg hover:bg-pink-100 transition-colors flex justify-center" aria-label="Add spouse"><Heart size={14} /></button>
                            )}
                            
                            <div className="no-print flex justify-around w-full mt-1 border-t pt-1">
                                <button onClick={() => onAdd(member.id, "Son", "male")} className="flex-1 p-1 text-sky-600 rounded-full hover:bg-sky-100 transition-colors" aria-label="Add son"><Male size={16} /></button>
                                <button onClick={() => onAdd(member.id, "Daughter", "female")} className="flex-1 p-1 text-pink-600 rounded-full hover:bg-pink-100 transition-colors" aria-label="Add daughter"><Female size={16} /></button>
                                {member.reportsTo !== null && (
                                    <button onClick={() => onRemove(member.id)} className="flex-1 p-1 text-red-500 rounded-full hover:bg-red-100 transition-colors" aria-label="Remove member"><X size={16} /></button>
                                )}
                            </div>
                        </div>
                        {hasChildren && (
                            <div className="no-print flex items-center justify-center w-full mt-1 px-1 space-x-2">
                                {member.isExpanded && children.length > 1 && isCarouselMode && (
                                    <button onClick={() => onSetActiveIndex(member.id, Math.max(0, activeIndex - 1))} className={`p-1 text-gray-500 rounded-full hover:bg-gray-200 transition-colors ${showPrevButton ? '' : 'invisible'}`} aria-label="Previous child"><ChevronLeft size={16} /></button>
                                )}
                                <div className="flex-grow flex items-center justify-center space-x-2">
                                  {member.isExpanded && children.length > 1 && (
                                      <button onClick={() => onToggleCarousel(member.id)} className="p-1.5 bg-gray-200 text-gray-600 rounded-full shadow-sm hover:bg-gray-300 transition-colors" aria-label="Toggle carousel view">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                                      </button>
                                  )}
                                  <button onClick={() => onToggleExpand(member.id)} className="p-1.5 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-colors" aria-label={member.isExpanded ? 'Collapse' : 'Expand'}>
                                      {member.isExpanded ? <Minus size={12} /> : <Plus size={12} />}
                                  </button>
                                </div>
                                {member.isExpanded && children.length > 1 && isCarouselMode && (
                                    <button onClick={() => onSetActiveIndex(member.id, Math.min(children.length - 1, activeIndex + 1))} className={`p-1 text-gray-500 rounded-full hover:bg-gray-200 transition-colors ${showNextButton ? '' : 'invisible'}`} aria-label="Next child"><ChevronRight size={16} /></button>
                                )}
                            </div>
                        )}
                    </div>
                    {member.isExpanded && hasChildren && (
                        <div className={`children-container relative flex items-start pt-6 gap-x-2 gap-y-4 max-w-full ${isCarouselMode ? 'flex-nowrap justify-center' : 'flex-wrap justify-center'}`}>
                               {children.map((child, index) => {
                                    const isVisibleInCarousel = !isCarouselMode || index === activeIndex;
                                    if (!isVisibleInCarousel) return null;
                                    return (
                                        <div key={child.id} className="tree-node-wrapper">
                                            <TreeNode member={child} onAdd={onAdd} onRemove={onRemove} onNameChange={onNameChange} onLastNameChange={onLastNameChange} onSpouseNameChange={onSpouseNameChange} onSpouseLastNameChange={onSpouseLastNameChange} onOpenStoryModal={onOpenStoryModal} onToggleExpand={onToggleExpand} onToggleCarousel={onToggleCarousel} onSetActiveIndex={onSetActiveIndex} onSetMarried={onSetMarried} searchTerm={searchTerm} nodeRefs={nodeRefs} />
                                        </div>
                                    );
                                })}
                        </div>
                    )}
                </div>
            );
        }

        // --- Main App Component ---
        const App = () => {
            const [familyData, setFamilyData] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [isStoryModalOpen, setIsStoryModalOpen] = useState(false);
            const [editingMember, setEditingMember] = useState(null);
            const [isSpouseEdit, setIsSpouseEdit] = useState(false);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [memberToRemove, setMemberToRemove] = useState(null);
            const nodeRefs = useRef({});
            const fileInputRef = useRef(null);

            // Load data from localStorage on initial render
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem('familyTreeData');
                    setFamilyData(savedData ? JSON.parse(savedData) : defaultFamilyData);
                } catch (error) {
                    console.error("Could not load family data:", error);
                    setFamilyData(defaultFamilyData);
                }
            }, []);

            // Function to save data and update state
            const updateFamilyData = (newData) => {
                setFamilyData(newData);
                localStorage.setItem('familyTreeData', JSON.stringify(newData));
            };
            
            // --- Handlers for family tree actions ---
            const handleAdd = (parentId, name, gender) => {
                const parent = familyData.find(m => m.id === parentId);
                if (!parent) return;

                const newMember = {
                    id: Date.now(),
                    name: name,
                    lastName: parent.lastName,
                    reportsTo: parentId,
                    isExpanded: true,
                    isCarouselMode: false,
                    activeIndex: 0,
                    spouseName: "", spouseLastName: "", isMarried: false,
                    gender: gender,
                    story: "", dob: "", placeOfBirth: "", isAlive: true,
                    spouseStory: "", spouseDob: "", spousePlaceOfBirth: "", spouseIsAlive: true,
                    generation: (parent.generation || 0) + 1
                };
                updateFamilyData([...familyData, newMember]);
            };

            const handleRemoveWithConfirmation = (id) => {
                const member = familyData.find(m => m.id === id);
                setMemberToRemove(member);
                setIsConfirmModalOpen(true);
            };
            
            const handleConfirmRemove = () => {
                if (!memberToRemove) return;
                let idsToRemove = [memberToRemove.id];
                const findDescendants = (parentId) => {
                    familyData.filter(m => m.reportsTo === parentId).forEach(child => {
                        idsToRemove.push(child.id);
                        findDescendants(child.id);
                    });
                };
                findDescendants(memberToRemove.id);
                updateFamilyData(familyData.filter(m => !idsToRemove.includes(m.id)));
                setIsConfirmModalOpen(false);
                setMemberToRemove(null);
            };
            
            const createHandler = (key) => (id, value) => {
                updateFamilyData(familyData.map(m => m.id === id ? { ...m, [key]: value } : m));
            };

            const onNameChange = createHandler('name');
            const onLastNameChange = createHandler('lastName');
            const onSpouseNameChange = createHandler('spouseName');
            const onSpouseLastNameChange = createHandler('spouseLastName');
            const onToggleExpand = (id) => updateFamilyData(familyData.map(m => m.id === id ? { ...m, isExpanded: !m.isExpanded } : m));
            const onToggleCarousel = (id) => updateFamilyData(familyData.map(m => m.id === id ? { ...m, isCarouselMode: !m.isCarouselMode } : m));
            const onSetActiveIndex = (id, index) => updateFamilyData(familyData.map(m => m.id === id ? { ...m, activeIndex: index } : m));

            const onSetMarried = (id, isMarried) => {
                updateFamilyData(familyData.map(m => {
                    if (m.id === id) {
                        const updated = { ...m, isMarried };
                        if (isMarried) {
                             if(m.gender === 'female' && !updated.spouseLastName) updated.spouseLastName = m.lastName;
                             if(!updated.spouseName) updated.spouseName = "New Spouse";
                        } else {
                            updated.spouseName = ""; updated.spouseLastName = ""; updated.spouseStory = "";
                            updated.spouseDob = ""; updated.spousePlaceOfBirth = ""; updated.spouseIsAlive = true;
                            updated.spouseDateOfDeath = ""; updated.spousePlaceOfCremation = "";
                        }
                        return updated;
                    }
                    return m;
                }));
            };

            const handleOpenStoryModal = (member, isSpouse) => {
                setEditingMember(member);
                setIsSpouseEdit(isSpouse);
                setIsStoryModalOpen(true);
            };

            const handleSaveStory = (id, details, isSpouse) => {
                updateFamilyData(familyData.map(m => {
                    if (m.id === id) {
                        const { story, dob, placeOfBirth, isAlive, dateOfDeath, placeOfCremation } = details;
                        if (isSpouse) {
                            return { ...m, spouseStory: story, spouseDob: dob, spousePlaceOfBirth: placeOfBirth, spouseIsAlive: isAlive, spouseDateOfDeath: dateOfDeath, spousePlaceOfCremation: placeOfCremation };
                        } else {
                            return { ...m, story, dob, placeOfBirth, isAlive, dateOfDeath, placeOfCremation };
                        }
                    }
                    return m;
                }));
                setIsStoryModalOpen(false);
            };

            // --- File Handlers ---
            const handleSaveToFile = () => {
                const jsonString = JSON.stringify(familyData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'family-tree.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImportFromFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            updateFamilyData(importedData);
                        } else {
                            alert('Invalid file format. Please import a valid JSON file.');
                        }
                    } catch (error) {
                        alert('Error reading or parsing file. Please ensure it is a valid JSON file.');
                        console.error("File import error:", error);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Reset file input
            };

            const handleExportToCSV = () => {
                const headers = [
                    'id', 'name', 'lastName', 'reportsTo', 'gender', 'dob', 'placeOfBirth', 'isAlive', 
                    'dateOfDeath', 'placeOfCremation', 'story', 'isMarried', 'spouseName', 'spouseLastName', 
                    'spouseDob', 'spousePlaceOfBirth', 'spouseIsAlive', 'spouseDateOfDeath', 
                    'spousePlaceOfCremation', 'spouseStory', 'generation'
                ];

                const escapeCSV = (str) => {
                    if (str === null || str === undefined) return '';
                    const s = String(str);
                    if (s.includes('"') || s.includes(',') || s.includes('\n')) {
                        return `"${s.replace(/"/g, '""')}"`;
                    }
                    return s;
                };

                const csvContent = [
                    headers.join(','),
                    ...familyData.map(row => headers.map(header => escapeCSV(row[header])).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'family-tree.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const familyTree = useMemo(() => {
                const dataMap = familyData.reduce((map, member) => {
                    map[member.id] = { ...member, children: [] };
                    return map;
                }, {});
                
                const tree = [];
                familyData.forEach(member => {
                    if (member.reportsTo && dataMap[member.reportsTo]) {
                       dataMap[member.reportsTo].children.push(dataMap[member.id]);
                    } else if (member.reportsTo === null) {
                        tree.push(dataMap[member.id]);
                    }
                });
                return tree;
            }, [familyData]);
            
            return (
                 <div className="p-4 sm:p-8">
                    <div className="no-print max-w-4xl mx-auto mb-6 bg-white p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-center gap-4">
                        <input
                            type="text"
                            placeholder="Search for a family member..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <div className="flex items-center gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleImportFromFile} accept=".json" className="hidden" />
                            <button onClick={() => fileInputRef.current.click()} className="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm whitespace-nowrap">Import</button>
                            <button onClick={handleSaveToFile} className="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm whitespace-nowrap">Save</button>
                            <button onClick={handleExportToCSV} className="w-full sm:w-auto px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors text-sm whitespace-nowrap">Export CSV</button>
                            <button onClick={() => window.print()} className="w-full sm:w-auto px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors text-sm whitespace-nowrap">Print</button>
                        </div>
                    </div>

                    <div className="flex flex-col items-center">
                        {familyTree.map(member => (
                            <div key={member.id} className="tree-node-wrapper">
                                <TreeNode
                                    member={member}
                                    onAdd={handleAdd}
                                    onRemove={handleRemoveWithConfirmation}
                                    onNameChange={onNameChange}
                                    onLastNameChange={onLastNameChange}
                                    onSpouseNameChange={onSpouseNameChange}
                                    onSpouseLastNameChange={onSpouseLastNameChange}
                                    onOpenStoryModal={handleOpenStoryModal}
                                    onToggleExpand={onToggleExpand}
                                    onToggleCarousel={onToggleCarousel}
                                    onSetActiveIndex={onSetActiveIndex}
                                    onSetMarried={onSetMarried}
                                    searchTerm={searchTerm}
                                    nodeRefs={nodeRefs}
                                />
                            </div>
                        ))}
                    </div>

                    <StoryModal
                        isOpen={isStoryModalOpen}
                        onClose={() => setIsStoryModalOpen(false)}
                        onSave={handleSaveStory}
                        member={editingMember}
                        isSpouse={isSpouseEdit}
                    />
                    
                    <ConfirmModal
                        isOpen={isConfirmModalOpen}
                        onCancel={() => setIsConfirmModalOpen(false)}
                        onConfirm={handleConfirmRemove}
                        message={`Are you sure you want to delete ${memberToRemove?.name} and all their descendants? This action cannot be undone.`}
                    />
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
